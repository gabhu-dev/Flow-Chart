/*! Rappid v3.1.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2020-03-01 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,l,v){"use strict";l=l&&l.hasOwnProperty("default")?l.default:l;var e=v.mvc.View.extend({className:"free-transform",events:{"mousedown .resize":"startResizing","mousedown .rotate":"startRotating","touchstart .resize":"startResizing","touchstart .rotate":"startRotating"},DIRECTIONS:["nw","n","ne","e","se","s","sw","w"],POSITIONS:["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"],options:{cellView:void 0,rotateAngleGrid:15,preserveAspectRatio:!1,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,allowOrthogonalResize:!0,resizeDirections:null,allowRotation:!0,clearAll:!0,clearOnBlankPointerdown:!0,usePaperScale:!1,padding:3},documentEvents:{mousemove:"pointermove",touchmove:"pointermove",mouseup:"pointerup",touchend:"pointerup"},init:function(){var t=this.options;t.cellView?v.util.defaults(t,{cell:t.cellView.model,paper:t.cellView.paper,graph:t.cellView.paper.model}):t.paper&&t.cell&&v.util.defaults(t,{cellView:t.cell.findView(t.paper),graph:t.paper.model});var e=t.paper;t.clearAll&&this.constructor.clear(e),this.startListening(),e.$el.append(this.el),this.constructor.registerInstanceToPaper(this,e)},startListening:function(){var t=this,e=this.options,i=e.cell,n=e.paper,r=e.graph,o=e.clearOnBlankPointerdown;this.listenTo(i,"change:size change:position change:angle",this.onCellAttributeChange),this.listenTo(n,"scale translate",function(){return t.requestUpdate()}),this.listenTo(r,"reset",function(){return t.remove()}),this.listenTo(i,"remove",function(){return t.remove()}),o&&this.listenTo(n,"blank:pointerdown",function(){return t.remove()})},onCellAttributeChange:function(t,e,i){i.updateHandled||this.requestUpdate()},renderHandles:function(){var t=this.options,i=this.POSITIONS,e=l("<div/>").prop("draggable",!1),n=e.clone().addClass("rotate"),r=i.map(function(t){return e.clone().addClass("resize").attr("data-position",t)}),o=t.resizeDirections;Array.isArray(o)&&r.forEach(function(t,e){o.includes(i[e])||t.hide()}),this.$el.empty().append(r,n)},render:function(){var t=this.options,e=this.$el,i=t.cell,n=t.preserveAspectRatio,r=t.allowRotation,o=t.allowOrthogonalResize;e.attr("data-type",i.get("type")),e.toggleClass("no-orthogonal-resize",n||!o),e.toggleClass("no-rotation",!r),this.renderHandles(),this.requestUpdate()},requestUpdate:function(t){var e=this.UPDATE_PRIORITY;this.options.paper.requestViewUpdate(this,1,e,t)},confirmUpdate:function(){this.update()},update:function(){this.options.usePaperScale?this.updateFrameScaled():this.updateFrameNoScale(),this.updateHandleDirections()},updateFrameScaled:function(){var t=this.options,e=t.paper,i=t.cell,n=t.padding,r=v.util.normalizeSides(n),o=r.left,a=r.right,s=r.top,l=r.bottom,h=i.getBBox().moveAndExpand({x:-o,y:-s,width:o+a,height:s+l}),p=h.x,c=h.y,d=h.width,g=h.height,u=i.angle(),m=e.matrix().translate(p,c).translate(d/2,g/2).rotate(u).translate(-d/2,-g/2),f=v.V.matrixToTransformString(m);this.$el.css({width:d,height:g,left:0,top:0,"transform-origin":"0 0",transform:f,"-webkit-transform":f,"-ms-transform":f})},updateFrameNoScale:function(){var t=this.options,e=t.paper,i=t.cell,n=t.padding,r=v.util.normalizeSides(n),o=r.left,a=r.right,s=r.top,l=r.bottom,h=e.matrix(),p=h.a,c=h.d,d=h.e,g=h.f,u=i.getBBox(),m=i.angle();u.x*=p,u.x+=d,u.y*=c,u.y+=g,u.width*=p,u.height*=c,u.moveAndExpand({x:-o,y:-s,width:o+a,height:s+l});var f="rotate("+m+"deg)";this.$el.css({width:u.width,height:u.height,left:u.x,top:u.y,"transform-origin":"50% 50%",transform:f,"-webkit-transform":f,"-ms-transform":f})},updateHandleDirections:function(){var t=this.options.cell.angle(),e=Math.floor(t*(this.DIRECTIONS.length/360));if(e!=this._previousDirectionsShift){var i=this.DIRECTIONS.slice(e).concat(this.DIRECTIONS.slice(0,e));this.$(".resize").removeClass(this.DIRECTIONS.join(" ")).each(function(t,e){l(e).addClass(i[t])}),this._previousDirectionsShift=e}},calculateTrueDirection:function(t){var e=this.options.cell,i=v.g.normalizeAngle(e.get("angle")),n=this.POSITIONS.indexOf(t);return n+=Math.floor(i*(this.POSITIONS.length/360)),n%=this.POSITIONS.length,this.POSITIONS[n]},startResizing:function(t){t.stopPropagation(),this.options.graph.startBatch("free-transform",{freeTransform:this.cid});var e=l(t.target).data("position"),i=this.calculateTrueDirection(e),n=0,r=0;e.split("-").forEach(function(t){n={left:-1,right:1}[t]||n,r={top:-1,bottom:1}[t]||r});var o=this.toValidResizeDirection(e),a={"top-right":"bottomLeft","top-left":"corner","bottom-left":"topRight","bottom-right":"origin"}[o],s={action:"resize",angle:v.g.normalizeAngle(this.options.cell.get("angle")||0),resizeX:n,resizeY:r,selector:a,direction:o,relativeDirection:e,trueDirection:i};this.startOp(t.target),this.delegateDocumentEvents(null,s)},toValidResizeDirection:function(t){return{top:"top-left",bottom:"bottom-right",left:"bottom-left",right:"top-right"}[t]||t},startRotating:function(t){t.stopPropagation(),this.options.graph.startBatch("free-transform",{freeTransform:this.cid});var e=this.options.cell.getBBox().center(),i=this.options.paper.snapToGrid({x:t.clientX,y:t.clientY}),n={action:"rotate",centerRotation:e,modelAngle:v.g.normalizeAngle(this.options.cell.get("angle")||0),startAngle:v.g.point(i).theta(e)};this.startOp(t.target),this.delegateDocumentEvents(null,n)},pointermove:function(t){var e=t.data,i=e.action;if(i){t=v.util.normalizeEvent(t);var n=this.options,r=n.paper.snapToGrid({x:t.clientX,y:t.clientY}),o=n.paper.options.gridSize,a=n.cell;switch(i){case"resize":var s=a.getBBox(),l=v.g.point(r).rotate(s.center(),e.angle).difference(s[e.selector]()),h=e.resizeX?l.x*e.resizeX:s.width,p=e.resizeY?l.y*e.resizeY:s.height;if(h=v.g.snapToGrid(h,o),p=v.g.snapToGrid(p,o),h=Math.max(h,n.minWidth||o),p=Math.max(p,n.minHeight||o),h=Math.min(h,n.maxWidth),p=Math.min(p,n.maxHeight),n.preserveAspectRatio){var c=s.width*p/s.height,d=s.height*h/s.width;h<c?p=d:h=c}s.width==h&&s.height==p||a.resize(h,p,{freeTransform:this.cid,direction:e.direction,relativeDirection:e.relativeDirection,trueDirection:e.trueDirection,ui:!0,minWidth:n.minWidth,minHeight:n.minHeight,maxWidth:n.maxWidth,maxHeight:n.maxHeight,preserveAspectRatio:n.preserveAspectRatio});break;case"rotate":var g=e.startAngle-v.g.point(r).theta(e.centerRotation);a.rotate(v.g.snapToGrid(e.modelAngle+g,n.rotateAngleGrid),!0,null,{freeTransform:this.cid})}}},pointerup:function(t){this.undelegateDocumentEvents(),t.data.action&&(this.stopOp(),this.options.graph.stopBatch("free-transform",{freeTransform:this.cid}))},onRemove:function(){e.unregisterInstanceFromPaper(this,this.options.paper)},startOp:function(t){t&&(l(t).addClass("in-operation"),this._elementOp=t),this.$el.addClass("in-operation"),this.options.paper.undelegateEvents()},stopOp:function(){this._elementOp&&(l(this._elementOp).removeClass("in-operation"),this._elementOp=null),this.$el.removeClass("in-operation"),this.options.paper.delegateEvents()}},{instancesByPaper:{},clear:function(t){t.trigger("freetransform:create"),this.removeInstancesForPaper(t)},removeInstancesForPaper:function(t){v.util.invoke(this.getInstancesForPaper(t),"remove")},getInstancesForPaper:function(t){return this.instancesByPaper[t.cid]||{}},registerInstanceToPaper:function(t,e){this.instancesByPaper[e.cid]||(this.instancesByPaper[e.cid]={}),this.instancesByPaper[e.cid][t.cid]=t},unregisterInstanceFromPaper:function(t,e){this.instancesByPaper[e.cid]&&(this.instancesByPaper[e.cid][t.cid]=null)}});t.FreeTransform=e}(this.joint.ui=this.joint.ui||{},$,joint);