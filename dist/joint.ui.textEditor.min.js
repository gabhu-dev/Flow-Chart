/*! Rappid v3.1.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2020-03-01 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,n,e,S){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n,e=e&&e.hasOwnProperty("default")?e.default:e;var h=S.mvc.View.extend({options:{text:void 0,newlineCharacterBBoxWidth:10,placeholder:void 0,focus:!0,debug:!1,selectAllThreshold:20,useNativeSelection:!0,annotateUrls:!1,urlAnnotation:{attrs:{class:"url-annotation",fill:"lightblue","text-decoration":"underline"}},textareaAttributes:{autocorrect:"off",autocomplete:"off",autocapitalize:"off",spellcheck:"false",tabindex:"0"}},className:"text-editor",events:{"keyup textarea":"onKeyup","input textarea":"onInput","copy textarea":"onCopy","cut textarea":"onCut","paste textarea":"onPaste","mousedown .char-selection-box":"onMousedown","dblclick .char-selection-box":"onDoubleClick","click .char-selection-box":"onTripleClick"},selection:{start:null,end:null},selecting:!1,init:function(){S.util.bindAll(this,"onMousedown","onMousemove","onMouseup","onDoubleClick","onTripleClick","onKeydown","onAfterPaste","onAfterKeydown");var t=this.options.text;if(!t)throw new Error("ui.TextEditor: text option is mandatory");this.setTextElement(t),n(document.body).on("mousemove",this.onMousemove),n(document.body).on("mouseup",this.onMouseup),n(document.body).on("keydown",this.onKeydown),this.$viewport=n(t),this.options.annotations&&this.setAnnotations(this.options.annotations)},setTextElement:function(t){this.$elText&&this.unbindTextElement(),this.options.text=t,this.$elText=n(t),this.$elText.on("mousedown",this.onMousedown),this.$elText.on("dblclick",this.onDoubleClick),this.$elText.on("click",this.onTripleClick)},render:function(t){this.$caret=n("<div>",{class:"caret"}),this.$selection=n("<div>"),this.$selectionBox=n("<div>",{class:"char-selection-box"}),this.$el.append(this.$caret,this.$selection),this.$textareaContainer=n("<div>",{class:"textarea-container"}),this.$textarea=n("<textarea>",this.options.textareaAttributes),this.textarea=this.$textarea[0],this._textContent=this.textarea.value=this.getTextContent(),this._textareaValueBeforeInput=this.textarea.value,this.$textareaContainer.append(this.textarea),this.options.focus&&this.$el.append(this.$textareaContainer),n(t||document.body).append(this.$el);var e=S.V(this.options.text).bbox();return this.$textareaContainer.css({left:e.x,top:e.y}),this.focus(),S.V(this.options.text).attr("cursor","text"),this.selectAll(),this},annotateURLBeforeCaret:function(t){var e=this.getURLBoundary(Math.max(t-1,0));return!!e&&(this.annotateURL(this.getAnnotations()||[],e[0],e[1]),!0)},hasSelection:function(){return S.util.isNumber(this.selection.start)&&S.util.isNumber(this.selection.end)&&this.selection.start!==this.selection.end},textContentHasChanged:function(){return this._textContent!==this.textarea.value},restoreTextAreaSelectionDirection:function(){this._selectionDirection&&(this.textarea.selectionDirection=this._selectionDirection)},storeSelectionDirection:function(){this._selectionDirection=this.textarea.selectionDirection},onKeydown:function(t){this.options.debug&&console.log("onKeydown(): ",t.keyCode),this.isModifierKey(t)||(this.hasSelection()&&(this.deselect(),this.restoreTextAreaSelectionDirection()),setTimeout(this.onAfterKeydown,0),this._copied=!1,this._selectionStartBeforeInput=this.textarea.selectionStart,this._selectionEndBeforeInput=this.textarea.selectionEnd)},onAfterKeydown:function(){this.textarea===document.activeElement&&(this.storeSelectionDirection(),this.updateSelectionFromTextarea())},updateSelectionFromTextarea:function(){var t=this.textarea,e=t.selectionStart,n=t.selectionEnd;e===n?this.setCaret(e):this.select(e,n)},textSelectionHasChanged:function(){var t=this.selection,e=this.textarea;return!(!t||!e)&&(t.start!==e.selectionStart||t.end!==e.selectionEnd)},isModifierKey:function(e){return[16,18,17,91].some(function(t){return e.which===t})},isArrowKey:function(t){return 37<=t.which&&t.which<=40},onKeyup:function(t){if(this.textContentHasChanged()&&this.onInput(t),this.textSelectionHasChanged()&&!this.isArrowKey(t)){var e=this.textarea;e.selectionEnd!==e.selectionStart&&this.updateSelectionFromTextarea()}},onCopy:function(t){this._copied||this.copyToClipboard()},onCut:function(t){this._copied||this.copyToClipboard()},copyToClipboard:function(){document.queryCommandSupported&&document.queryCommandSupported("copy")&&(this._copied=!0,document.execCommand("copy"))},onInput:function(t){if(this.textContentHasChanged()){var e=this.textarea.value.length-this._textareaValueBeforeInput.length,n={start:this._selectionStartBeforeInput,end:this._selectionEndBeforeInput},i={start:this.textarea.selectionStart,end:this.textarea.selectionEnd};this.options.debug&&console.log("onInput()",t,"selectionBeforeInput",n,"selectionAfterInput",i,"diffLength",e);var o=this.inferTextOperationType(n,i,e),s=!1,r=this.getAnnotations();if(this.options.annotateUrls&&"insert"===o){var a=this.textarea.value.substr(n.start,e);this.options.debug&&console.log("onInput()","inserted text",a),/\s/.test(a)&&(s=this.annotateURLBeforeCaret(n.start))&&(r=this.shiftAnnotations(r,i.end,e))}if(r&&(s||(r=this.annotate(r,n,i,e)),this.options.debug&&console.log("onInput()","modified annotations",r),this._currentAnnotationAttributes&&"insert"===o)){var h={start:n.start,end:i.end,attrs:this._currentAnnotationAttributes};r.push(h),this._currentAnnotationAttributes=void 0,this.options.debug&&console.log("onInput()","insert annotation",h,"final annotations",r)}this._annotations=r,this.trigger("text:change",this.textarea.value,this._textareaValueBeforeInput,r,n,i),this._selectionBeforeInput=i,this._textareaValueBeforeInput=this.textarea.value,this._textContent=this.textarea.value}},onPaste:function(t){this.options.debug&&console.log("onPaste()"),this._textareaValueBeforeInput=this.textarea.value,setTimeout(this.onAfterPaste,0)},onAfterPaste:function(){this.setCaret(this.textarea.selectionStart)},onMousedown:function(t){if(3!==t.originalEvent.detail){this.options.debug&&console.log("onMousedown()");var e=this.getCharNumFromEvent(t);this.startSelecting(),this.select(e),t.preventDefault(),t.stopPropagation()}},onMousemove:function(t){if(this.selectionInProgress()){this.options.debug&&console.log("onMousemove()");var e=this.getCharNumFromEvent(t);this.storeSelectionDirection(),this.select(null,e),t.preventDefault(),t.stopPropagation()}},onMouseup:function(t){this.selectionInProgress()&&(this.options.debug&&console.log("onMouseup()"),this.stopSelecting(),this.trigger("select:changed",this.selection.start,this.selection.end))},onDoubleClick:function(t){this.options.debug&&console.log("onDoubleClick()");var e=this.getCharNumFromEvent(t),n=this.getWordBoundary(e);this.select(n[0],n[1]),t.preventDefault(),t.stopPropagation()},onTripleClick:function(t){3===t.originalEvent.detail&&(this.options.debug&&console.log("onTripleClick()"),this.hideCaret(),this.selectAll(),t.preventDefault(),t.stopPropagation())},findAnnotationsUnderCursor:function(t,e){return S.V.findAnnotationsAtIndex(t,e)},findAnnotationsInSelection:function(t,e,n){return S.V.findAnnotationsBetweenIndexes(t,e,n)},inferTextOperationType:function(t,e,n){return t.start===t.end&&e.start===e.end&&0<n?"insert":t.start===t.end&&e.start===e.end&&n<=0?"delete-single":t.start!==t.end&&e.start===e.end&&e.start===t.start?"delete":t.start!==t.end&&e.start!==t.start?"delete-insert":void 0},annotate:function(t,o,s,r){var a=[],h=this.inferTextOperationType(o,s,r);return S.util.toArray(t).forEach(function(t){var e,n;switch(h){case"insert":t.start<o.start&&o.start<=t.end?t.end+=r:t.start>=o.start&&(t.start+=r,t.end+=r);break;case"delete-single":t.start<o.start&&o.start<=t.end&&o.start!==s.start?t.end+=r:t.start<=o.start&&o.start<t.end&&o.start===s.start?t.end+=r:t.start>=o.start&&(t.start+=r,t.end+=r);break;case"delete":t.start<=o.start&&o.start<=t.end?o.end<=t.end?t.end+=r:t.end+=s.start-t.end:t.start>=o.start&&t.start<o.end?(e=t.end-t.start,n=o.end-t.start,t.start=o.start,t.end=t.start+e-n):t.start>=o.end&&(t.start+=r,t.end+=r);break;case"delete-insert":if(t.start<=o.start&&o.start<=t.end)o.start<t.end&&(o.end>t.end?t.end=s.end:t.end=s.end+(t.end-o.end));else if(t.start>=o.start&&t.start<=o.end){var i=s.start-o.start;n=o.end-t.start,e=t.end-t.start,t.start=o.start+i,t.end=t.start+e-n}else t.start>=o.start&&t.end<=o.end?t.start=t.end=0:t.start>=o.end&&(t.start+=r,t.end+=r);break;default:this.options.debug&&console.log("ui.TextEditor: Unknown text operation.")}t.end>t.start&&a.push(t)},this),a},shiftAnnotations:function(t,e,n){return S.V.shiftAnnotations(t,e,n)},setCurrentAnnotation:function(t){this._currentAnnotationAttributes=t},setAnnotations:function(t){this._annotations=t},getAnnotations:function(){return this._annotations},getCombinedAnnotationAttrsAtIndex:function(e,t){var n={};return S.util.toArray(t).forEach(function(t){void 0===t.start&&void 0===t.end?S.V.mergeAttrs(n,t.attrs):e>=t.start&&e<t.end&&S.V.mergeAttrs(n,t.attrs)}),n},getSelectionAttrs:function(t,e){var n=t.start,i=t.end;if(n===i&&0===n)return this.getCombinedAnnotationAttrsAtIndex(n,e);if(n===i)return this.getCombinedAnnotationAttrsAtIndex(n-1,e);for(var o,s=n;s<i;s++){var r=this.getCombinedAnnotationAttrsAtIndex(s,e);if(o&&!S.util.isEqual(o,r)){o=S.util.flattenObject(S.V.mergeAttrs({},o)),r=S.util.flattenObject(S.V.mergeAttrs({},r));var a={};S.util.forIn(r,function(t,e){o[e]===r[e]&&S.util.setByPath(a,e,t)}),o=a}else o=r}return o},getTextContent:function(){var t=this.options.text,e=S.V(t).find(".v-line");return 0===e.length?t.textContent:e.reduce(function(t,e,n,i){var o=e.node.textContent;return e.hasClass("v-empty-line")&&(o=""),n===i.length-1?t+o:t+o+"\n"},"")},startSelecting:function(){this.selecting=!0},stopSelecting:function(){this.selecting=!1},selectionInProgress:function(){return!0===this.selecting},selectAll:function(){return this.select(0,this.getNumberOfChars())},select:function(t,e){return this.options.debug&&console.log("select(",t,e,")"),void 0===e&&(e=t),S.util.isNumber(t)&&(this.selection.start=t),S.util.isNumber(e)&&(this.selection.end=e),S.util.isNumber(this.selection.end)||(this.selection.end=this.selection.start),S.util.isNumber(this.selection.start)&&S.util.isNumber(this.selection.end)&&(this.selection.start===this.selection.end?(this.clearSelection(),this.focus(),this.setCaret(this.selection.start)):(this.hideCaret(),this.renderSelection(this.selection.start,this.selection.end)),this.trigger("select:change",this.selection.start,this.selection.end)),this},setTextAreaSelection:function(t,e){var n={start:t,end:e};n=this.normalizeSelectionRange(n),this.textarea.focus(),this.textarea.selectionStart=n.start,this.textarea.selectionEnd=n.end},renderSelection:function(t,e){this.options.debug&&console.log("renderSelection()");var n={start:t,end:e};if(n=this.normalizeSelectionRange(n),this.clearSelection(),this.options.useNativeSelection){this.$viewport&&(this._viewportUserSelectBefore=this.$viewport.css("user-select"),this.$viewport.css({"-webkit-user-select":"all","-moz-user-select":"all","user-select":"all"}));var i=n.end-n.start;this.selectTextInElement(this.options.text,n.start,i)}else this.renderSelectionBoxes(n.start,n.end)},normalizeSelectionStartAndLength:function(t,e,n){var i=t.substr(0,e),o=t.substr(e,n);e-=this.countLineBreaks(i),n-=this.countLineBreaks(o);var s=this.countEmptyLines(i);return n+=s,n-=s,{start:e+=s,length:n+=this.countEmptyLines(o)}},selectTextInElement:function(e,n,i){if(S.util.isFunction(e.selectSubString)&&this.selectTextInElementUsingSelectSubString(e,n,i),!this.actualSelectionMatchesExpectedSelection(n,i))try{this.selectTextInElementUsingRanges(e,n,i)}catch(t){this.options.debug&&console.log(t),S.util.isFunction(e.selectSubString)&&this.selectTextInElementUsingSelectSubString(e,n,i)}},selectTextInElementUsingSelectSubString:function(t,e,n){var i=this.normalizeSelectionStartAndLength(this.getTextContent(),e,n);try{t.selectSubString(i.start,i.length)}catch(t){this.options.debug&&console.log(t)}},selectTextInElementUsingRanges:function(t,e,n){var i=window.getSelection();i.removeAllRanges();var o=this.normalizeSelectionStartAndLength(this.getTextContent(),e,n);e=0+o.start,n=0+o.length;for(var s,r,a,h,l,c,u=this.getTextNodesFromDomElement(t),d=0,g=e+n;0<n&&0<u.length;)h=(a=d)+(s=u.shift()).length,(e<=a&&a<g||e<h&&h<=g||a<=e&&e<h||a<g&&g<=h)&&(l=Math.max(e-a,0),c=Math.min(l+Math.min(n,s.length),h),(r=document.createRange()).setStart(s,l),r.setEnd(s,c),i.addRange(r),n-=c-l),d+=s.length},actualSelectionMatchesExpectedSelection:function(t,e){var n=window.getSelection().toString();return this.getExpectedSelectedContent(t,e)===(n=n.replace(/\s/g," "))},getExpectedSelectedContent:function(t,e){var n=this.getTextContent().substr(t,e);return 0===n.search(/(\n\r|\r|\n)/)&&(n="-"+n),n=(n=(n=n.replace(/(\n\r|\r|\n){2,}/g,function(t){return Array.from({length:t.length-1},function(){return"-"}).join("")})).replace(/\n\r|\r|\n/g,"")).replace(/\s/g," ")},getTextNodesFromDomElement:function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var o=t.childNodes[n];void 0!==o.tagName?e=e.concat(this.getTextNodesFromDomElement(o)):e.push(o)}return e},renderSelectionBoxes:function(e,n){this.options.debug&&console.log("renderSelectionBoxes()"),this.$selection.empty();for(var t,i,o,s=this.getFontSize(),r=this.getTextTransforms(),a=r.rotation,h=e;h<n;h++){var l=this.$selectionBox.clone();try{o=this.getCharBBox(h)}catch(t){this.trigger("select:out-of-range",e,n);break}i&&0===a&&Math.round(o.y)===Math.round(i.y)&&Math.round(o.height)===Math.round(i.height)&&Math.round(o.x)===Math.round(i.x+i.width)?t.css({width:"+="+o.width}):(l.css({left:o.x,top:o.y-o.height,width:o.width,height:o.height,"-webkit-transform":"rotate("+a+"deg)","-webkit-transform-origin":"0% 100%","-moz-transform":"rotate("+a+"deg)","-moz-transform-origin":"0% 100%"}),this.$selection.append(l),t=l),i=o}o&&this.$textareaContainer.css({left:o.x,top:o.y-s*r.scaleY})},clearSelection:function(){return this.options.debug&&console.log("clearSelection()"),this.$selection.empty(),this.options.text.selectSubString&&(this.$viewport&&this._viewportUserSelectBefore&&this.$viewport.css({"-webkit-user-select":this._viewportUserSelectBefore,"-moz-user-select":this._viewportUserSelectBefore,"user-select":this._viewportUserSelectBefore}),window.getSelection().removeAllRanges()),this},deselect:function(){return this.options.debug&&console.log("deselect()"),this.stopSelecting(),this.clearSelection(),this.setTextAreaSelection(this.selection.start,this.selection.end),this},getSelectionStart:function(){return this.selection.start},getSelectionEnd:function(){return this.selection.end},getSelectionRange:function(){return this.normalizeSelectionRange(this.selection)},normalizeSelectionRange:function(t){return(t=S.util.clone(t)).start>t.end&&(t.end=[t.start,t.start=t.end][0]),t},getSelectionLength:function(){var t=this.getSelectionRange();return t.end-t.start},getSelection:function(){var t=this.getSelectionRange();return this.getTextContent().slice(t.start,t.end)},getWordBoundary:function(t){for(var e=this.textarea.value,n=/\W/,i=t;i;){if(n.test(e[i])){i+=1;break}i-=1}for(var o=this.getNumberOfChars(),s=t;s<o&&!n.test(e[s]);)s+=1;return i<s?[i,s]:[s,i]},getURLBoundary:function(t){for(var e=this.textarea.value,n=/\s/,i=t;i;){if(n.test(e[i])){i+=1;break}i-=1}for(var o=this.getNumberOfChars(),s=t;s<=o&&!n.test(e[s]);)s+=1;if(/[-a-zA-Z0-9@:%_+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_+.~#?&//=]*)?/.test(e.substring(i,s)))return[i,s]},annotateURL:function(t,e,n){var i=this.textarea.value.substring(e,n),o=S.util.assign({url:i},this.options.urlAnnotation);return o.start=e,o.end=n,S.util.isEqual(o,t[t.length-1])||t.push(o),t},getCharBBox:function(t){if(this.isLineEnding(t)){var e=this.getCharBBox(t-1);return e.x=e.x2,e.y=e.y2,e.width=this.options.newlineCharacterBBoxWidth||10,e}this.ensureTextVisibility();var n=this.realToSvgCharNum(t),i=this.options.text,o=i.getStartPositionOfChar(n),s=i.getEndPositionOfChar(n),r=i.getExtentOfChar(n);o=this.localToScreenCoordinates(o),s=this.localToScreenCoordinates(s);var a=this.getTextTransforms();return{x:o.x,y:o.y,width:r.width*a.scaleX,height:r.height*a.scaleY,x2:s.x,y2:s.y}},realToSvgCharNum:function(t){for(var e=0,n=0;n<=t;n++)this.isLineEnding(n)&&(e+=1);return t-e},selectionStartToSvgCharNum:function(t){return t-this.nonEmptyLinesBefore(t)},isLineEnding:function(t){var e=this.textarea.value;return"\n"===e[t]&&0<t&&"\n"!==e[t-1]},svgToRealCharNum:function(t){for(var e=0,n=0;n<=t+e;n++)this.isLineEnding(n)&&(e+=1);return t+e},ensureTextVisibility:function(){n(this.options.text).show()},localToScreenCoordinates:function(t){return S.V.transformPoint(t,this.options.text.getCTM())},getNumberOfChars:function(){return this.getTextContent().length},getCharNumFromEvent:function(t){this.ensureTextVisibility();var e=this.options.text,n=t.clientX,i=t.clientY,o=S.V(e).toLocalPoint(n,i),s=e.getCharNumAtPosition(o);if(s<0){var r=S.V(e).getBBox(),a=r.containsPoint(o);if(!a&&this.hasSelection()&&r.clone().inflate(this.options.selectAllThreshold).containsPoint(o))return this.selection.end;var h=a?o:r.pointNearestToPoint(o),l=S.V.createSVGPoint(h.x,h.y),c=e.getCharNumAtPosition(l);if(-1<c)return this.svgToRealCharNum(c);var u,d=0<o.x,g=r.x,f=r.x+r.width,p=g+f/2;do{l.x=p;var x=e.getCharNumAtPosition(l);-1<x&&(c=x),u=p,d&&-1<x||!d&&-1===x?(p=(p+f)/2,g=u):(p=(g+p)/2,f=u)}while(1<Math.abs(u-p));return-1<c?this.svgToRealCharNum(c)+(d?1:0):o.x<0&&o.y<r.y+r.height?0:this.getNumberOfChars()}var m=this.localToScreenCoordinates(o),v=this.getCharBBox(this.svgToRealCharNum(s));return Math.abs(v.x-m.x)<Math.abs(v.x+v.width-m.x)?this.svgToRealCharNum(s):this.svgToRealCharNum(s)+1},lineNumber:function(t){var e=this.textarea.value.substr(0,t);return this.countLineBreaks(e)},emptyLinesBefore:function(t){for(var e=this.textarea.value.split(/\n\r|\r|\n/g),n=0,i=this.lineNumber(t)-1;0<=i;i--)e[i]||(n+=1);return n},countLineBreaks:function(t){return(t.match(/\n\r|\r|\n/g)||[]).length},countEmptyLines:function(t){var e=(t.match(/(\n\r|\r|\n){2,}/g)||[]).reduce(function(t,e){return t+(e.length-1)},0);return 0===t.search(/(\n\r|\r|\n)/)&&e++,e},nonEmptyLinesBefore:function(t){return this.lineNumber(t)-this.emptyLinesBefore(t)},isEmptyLine:function(t){return!this.textarea.value.split(/\n\r|\r|\n/g)[t]},isEmptyLineUnderSelection:function(t){var e=this.lineNumber(t);return this.isEmptyLine(e)},getTextTransforms:function(){var t=this.options.text.getCTM();return S.V.decomposeMatrix(t)},getFontSize:function(){return parseInt(S.V(this.options.text).attr("font-size"),10)},getTextAnchor:function(){return S.V(this.options.text).attr("text-anchor")||""},setCaret:function(t,e){this.ensureTextVisibility(),S.util.isObject(t)&&(e=t,t=void 0),e=e||{};var n,i=this.options.text,o=this.getNumberOfChars(),s=this.selection.start,r=this.textarea.value;void 0!==t&&(t=Math.min(Math.max(t,0),o),s=this.selection.start=this.selection.end=t),e.silent||this.trigger("caret:change",s),this.setTextAreaSelection(s,s),this.options.debug&&console.log("setCaret(",t,e,")","selectionStart",s,"isLineEnding",this.isLineEnding(s),"isEmptyLineUnderSelection",this.isEmptyLineUnderSelection(s),"svgCharNum",this.selectionStartToSvgCharNum(s),"nonEmptyLinesBefore",this.nonEmptyLinesBefore(s));try{var a;n=this.isEmptyLineUnderSelection(s)||!this.isLineEnding(s)&&r.length!==s?(a=this.selectionStartToSvgCharNum(s),i.getStartPositionOfChar(a)):(a=this.selectionStartToSvgCharNum(s)-1,i.getEndPositionOfChar(a))}catch(t){this.trigger("caret:out-of-range",s),n={x:0,y:0}}var h=this.localToScreenCoordinates(n),l=this.getTextTransforms(),c=l.rotation,u=this.getFontSize()*l.scaleY;return this.options.placeholder&&this.$caret.toggleClass("placeholder",0===o),this.$caret.css({left:h.x,top:h.y-u,height:u,"line-height":u+"px","font-size":u+"px","-webkit-transform":"rotate("+c+"deg)","-webkit-transform-origin":"0% 100%","-moz-transform":"rotate("+c+"deg)","-moz-transform-origin":"0% 100%"}).attr({"text-anchor":this.getTextAnchor()}).show(),this.$textareaContainer.css({left:h.x,top:h.y-u}),this.focus(),this},focus:function(){return this.options.debug&&console.log("focus()"),this.showCaret(),this},blur:function(){return this.options.debug&&console.log("blur()"),this.hideCaret(),this},showCaret:function(){return this.options.debug&&console.log("showCaret()"),this.$caret.show(),this},hideCaret:function(){return this.options.debug&&console.log("hideCaret()"),this.$caret.hide(),this},unbindTextElement:function(){this.$elText.off("mousedown",this.onMousedown),this.$elText.off("dblclick",this.onDoubleClick),this.$elText.off("click",this.onTripleClick)},onRemove:function(){this.deselect(),this.unbindTextElement(),n(document.body).off("mousemove",this.onMousemove),n(document.body).off("mouseup",this.onMouseup),n(document.body).off("keydown",this.onKeydown),S.V(this.options.text).attr("cursor","")}},S.util.assign({getTextElement:function(t){var e=t.tagName.toUpperCase();if("TEXT"===e||"TSPAN"===e||"TEXTPATH"===e)return"TEXT"===e?t:this.getTextElement(t.parentNode)},edit:function(t,e){var i=this,n=!1!==(e=e||{}).update;this.options=S.util.assign({},e,{update:n});var o=this.getTextElement(t);if(o){var s;this.close(),this.ed=new h(S.util.assign({text:o},e)),this.ed.on("all",this.trigger,this);var r=e.cellView;if(r){if(s=r.paper.el,this.cellViewUnderEdit=r,this.cellViewUnderEditInteractiveOption=this.cellViewUnderEdit.options.interactive,this.cellViewUnderEdit.options.interactive=!1,e.annotationsProperty&&!this.ed.getAnnotations()){var a=this.cellViewUnderEdit.model.prop(e.annotationsProperty);a&&this.ed.setAnnotations(this.deepCloneAnnotations(a))}}else s=S.V(o).svg().parentNode;return n&&this.ed.on("text:change",function(t,e,n){r?i.updateCellView(r,t,n):i.updateSVGTextNode(o,t,n)}),this.ed.render(s),this}this.options.debug&&console.log("ui.TextEditor: cannot find a text element.")},updateCellView:function(t,e,n){var i=this.options,o=i.textProperty,s=i.annotationsProperty,r=this.ed.cid,a=t.model;o&&a.prop(o,e,{textEditor:r,async:!1}),s&&a.prop(s,this.deepCloneAnnotations(n),{rewrite:!0,textEditor:r,async:!1})},updateSVGTextNode:function(t,e,n){S.V(t).text(e,{annotations:n})},close:function(){if(this.ed){if(this.ed.options.annotateUrls){var t=this.ed.getSelectionStart();if(!this.findAnnotationsUnderCursor().find(function(t){return!!t.url&&t}))this.ed.annotateURLBeforeCaret(t)&&this.applyAnnotations(this.getAnnotations())}this.ed.remove(),this.cellViewUnderEdit&&(this.cellViewUnderEdit.options.interactive=this.cellViewUnderEditInteractiveOption),this.ed=this.cellViewUnderEdit=this.cellViewUnderEditInteractiveOption=void 0}},applyAnnotations:function(t){var e=this.options,n=this.ed;if(n&&e.update){e.cellView&&e.annotationsProperty?(e.cellView.model.prop(e.annotationsProperty,this.deepCloneAnnotations(t),{rewrite:!0,textEditor:n.cid}),n.setAnnotations(t)):S.V(n.options.text).text(n.getTextContent(),{annotations:t});var i=this.getSelectionRange();0<this.getSelectionLength()?n.select(i.start,i.end):n.setCaret()}},deepCloneAnnotations:function(t){try{return JSON.parse(JSON.stringify(t))}catch(t){return}},proxy:function(t,e){if(this.ed)return this.ed[t].apply(this.ed,e)},setCurrentAnnotation:function(t){return this.proxy("setCurrentAnnotation",arguments)},getAnnotations:function(){return this.proxy("getAnnotations",arguments)},setCaret:function(){return this.proxy("setCaret",arguments)},deselect:function(){return this.proxy("deselect",arguments)},selectAll:function(){return this.proxy("selectAll",arguments)},select:function(){return this.proxy("select",arguments)},getNumberOfChars:function(){return this.proxy("getNumberOfChars",arguments)},getCharNumFromEvent:function(){return this.proxy("getCharNumFromEvent",arguments)},getWordBoundary:function(){return this.proxy("getWordBoundary",arguments)},findAnnotationsUnderCursor:function(){return this.proxy("findAnnotationsUnderCursor",[this.ed.getAnnotations(),this.ed.getSelectionStart()])},findAnnotationsInSelection:function(){if(this.ed){var t=this.ed.getSelectionRange();return this.proxy("findAnnotationsInSelection",[this.ed.getAnnotations(),t.start,t.end])}},getSelectionAttrs:function(t){if(this.ed){var e=this.ed.getSelectionRange();return this.proxy("getSelectionAttrs",[e,t])}},getSelectionLength:function(){return this.proxy("getSelectionLength",arguments)},getSelectionRange:function(){return this.proxy("getSelectionRange",arguments)}},e.Events));t.TextEditor=h}(this.joint.ui=this.joint.ui||{},$,Backbone,joint);